# DuckTodo 系统功能架构

## 1. 架构概览

DuckTodo 采用模块化分层设计，整合了传统项目管理与现代化 AI 协作能力。系统核心架构围绕“用户-团队-任务-知识”四大维度展开，辅以灵活的图谱构建能力和第三方集成服务。

## 2. 核心功能模块

### 2.1 用户与安全中心 (User & Security Center)
**功能描述**: 提供从身份认证、安全风控到个性化AI配置的全链路用户服务。

*   **身份认证 (Authentication)**:
    *   **多因子注册/登录**: 支持用户名/邮箱/手机号注册，密码采用 `Argon2 + Salt` 高强度哈希存储，防止彩虹表攻击。
    *   **OAuth2.0 集成**: 内置 Google, Github, WeChat 等主流平台的 SSO 单点登录流程。
    *   **会话管理**: 基于 Token 的无状态会话机制，支持多端同步在线与远程下线。
*   **安全凭证 (Security Credentials)**:
    *   **API 密钥管理**: 用户可自主生成/轮换 `AccessKey/SecretKey`，用于第三方应用接入或自动化脚本调用。
    *   **敏感操作风控**: 涉及删除项目、重置密码等高危操作时，强制触发二次验证（密码或验证码）。
*   **智能配置 (Intelligent Config)**:
    *   **LLM 网关配置**: 支持用户自带 Key (BYOK) 模式，配置 OpenAI, ModelScope, Ollama 等大模型服务，自定义 `Temperature` 与 `Thinking` 参数。
    *   **通知渠道集成**: 深度集成钉钉机器人 (DingTalk Robot)，支持通过 Webhook 实现任务动态的群消息推送，并可设置关键词过滤。

### 2.2 项目协作引擎 (Project Collaboration Engine)
**功能描述**: 打造企业级的多租户团队管理与项目全生命周期控制中台。

*   **团队管理 (Team Governance)**:
    *   **RBAC 权限模型**: 
        *   `Owner`: 拥有最高裁决权，负责团队生命周期、支付与全局设置。
        *   `Manager`: 负责业务运营，管理成员邀请、任务族规划及全局任务调度。
        *   `Member`: 专注执行，仅拥有任务协作与附件上传权限。
    *   **成员全生命周期**: 覆盖从“邮件邀请/链接邀请” -> “审核加入” -> “角色变更” -> “禁用/离职”的全流程。
    *   **离职交接**: 提供“一键资产转移”功能，将离职成员名下的未完成任务批量指派给继任者。
*   **项目全景 (Project Overview)**:
    *   **生命周期管理**: 支持项目的创建、归档（只读模式）及彻底销毁（级联删除所有关联数据）。
    *   **全局偏好**: 支持自定义项目主题色、任务优先级别名（如将 P0 显示为“立刻马上”）。
    *   **效能报表**: 内置团队燃尽图、成员活跃度热力图及任务分布饼图。

### 2.3 任务族容器 (Task Group Container)
**功能描述**: 构建灵活的任务分类隔离层，适配敏捷开发、OKR 等多种管理方法论。

*   **多态容器体系**:
    *   **项目公开任务族**: 默认对团队全员可见，适用于透明化协作场景（如“迭代规划”、“Bug修复”）。
    *   **项目私有任务族**: 实施严格的 ACL 访问控制，仅创建者及白名单成员可见（如“薪酬调整”、“核心机密”）。
    *   **个人微任务族**: 独立于团队之外的个人沙箱，数据物理隔离，仅用户本人可见（如“个人备忘”、“临时灵感”）。
*   **容器个性化**:
    *   **视觉识别**: 支持为不同任务族设置专属 `Color Tag`，在侧边栏实现视觉快速索引。
    *   **拖拽排序**: 支持通过 Drag-and-Drop 调整任务族的展示优先级。

### 2.4 任务执行系统 (Task Execution System)
**功能描述**: 驱动核心业务流转的精密齿轮，确保任务“件件有着落”。

*   **全生命周期流转**:
    *   **有限状态机 (FSM)**: 严格定义 `Pending` -> `In Progress` -> `Completed` -> `Canceled` 的状态跃迁逻辑。
    *   **精细化属性**: 
        *   **优先级**: P0 (紧急) - P4 (暂缓) 5级划分。
        *   **时间维度**: 计划开始时间、截止时间（Due Date）及实际完成时间的三维记录。
*   **结构化拆解**:
    *   **子任务体系 (Sub-tasks)**: 支持将父任务拆解为扁平化的子任务列表，每个子任务拥有独立状态机与指派人。
    *   **进度联动**: 支持“自动计算”模式，父任务进度条由子任务完成比例自动驱动（如 3/5 = 60%）。
*   **审计追踪**:
    *   **全链路日志**: 记录任务/子任务的 Create/Update/Delete 操作。
    *   **变更回溯**: 详细记录字段级变更前后的值，支持审计查询。
*   **深度协作**:
    *   **责任制**: 强制单一 `Assignee` 制度，避免责任推诿。
    *   **旁观者**: 支持无限添加 `Followers`，触发“任务变动”或“评论@”时的实时通知。
    *   **资源挂载**: 集成文件服务，支持多格式附件上传，并记录上传者溯源信息。

### 2.5 知识图谱与泛化节点 (Knowledge Graph & Advanced Nodes)
**功能描述**: 打破线性列表限制，构建基于图论（Graph Theory）的复杂任务网络。

*   **图谱构建引擎**:
    *   **自动拓扑**: 系统监听任务创建事件，自动将 Task/ChildTask 映射为图谱节点，并生成层级边。
    *   **自由编排**: 提供无限画布，支持用户拖拽节点坐标，进行思维导图式的布局整理。
*   **关系网络**:
    *   **强依赖 (Sequential)**: 阻塞式依赖，前置任务未 Done 时，后置任务自动锁定。
    *   **弱依赖 (Parallel)**: 逻辑关联，仅作视觉提示，不影响状态流转。
    *   **引用关联 (Reference)**: 用于关联相关文档或补充信息。
*   **泛化节点生态**:
    *   **笔记节点**: 内置 Markdown 编辑器，用于记录需求文档或会议纪要。
    *   **外部资源**: 支持嵌入 URL (外链网页) 或云存储地址 (外链文件)。
    *   **数据资产**: 
        *   **JSON 节点**: 结构化存储配置信息。
        *   **Secret 节点**: 采用 AES-256 加密存储账号密码等敏感信息，查看需二次验证。
    *   **可见性控制**: 节点级 ACL，支持将特定节点设为“仅自己可见”，在公共图谱中隐藏敏感信息。

### 2.6 多维可视化视图 (Multi-dimensional Views)
**功能描述**: 通过多视角投影，满足不同角色的信息获取需求。

*   **仪表盘 (Dashboard)**:
    *   **今日聚焦**: 智能筛选 `Due Today` 及 `Overdue` 任务，构建沉浸式工作台。
    *   **动态流**: 实时聚合协作通知，点击即可跳转上下文。
*   **日程视图 (Calendar)**:
    *   **多维切换**: 支持月/周/日视图无缝切换。
    *   **交互式排期**: 支持在日历上直接拖拽任务色块调整起止时间。
*   **甘特图 (Gantt)**:
    *   **关键路径**: 基于依赖关系自动计算并高亮 Critical Path。
    *   **资源视图**: 展示时间轴上的任务堆叠，辅助识别资源瓶颈。
*   **数据面板 (Analytics)**:
    *   **个人效能**: 统计任务完成率、平均响应时间 (MTTR)。
    *   **团队全景**: 可视化展示项目进度燃尽图与成员负载分布。

## 3. 数据库实体映射关系

系统底层基于关系型数据库构建，主要实体关系如下：

*   **User (用户)**
    *   1:1 -> User Security (安全凭证)
    *   1:N -> User LLM Config (AI配置)
    *   1:N -> Dingtalk Robot (通知配置)
*   **Team (团队)**
    *   1:N -> Team User Relation (成员)
    *   1:N -> Task Group (任务族)
    *   1:N -> Task (任务)
*   **Task Structure (任务结构)**
    *   Task Group 1:N -> Task
    *   Task 1:N -> Child Task (子任务)
    *   Task 1:N -> Task File (附件)
    *   Task 1:N -> Task Audit (审计日志)
*   **Graph (图谱)**
    *   Task/Child Task/Team/Group -> Task Node (节点映射)
    *   Task Node 1:N -> Task Edge (边关系)

## 4. 技术特性

*   **安全性**: 敏感数据加密 (密码/凭证)，细粒度权限控制 (RBAC)。
*   **扩展性**: 基于 Node/Edge 的图谱架构，易于扩展新的业务实体。
*   **智能化**: 底层预留 LLM 接口，支持未来 AI 辅助功能接入。
