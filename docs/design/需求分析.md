# DuckTodo 需求分析文档

## 1. 项目概述
DuckTodo 是一款功能全面的任务协作管理软件，旨在通过结构化的项目管理、灵活的任务编排以及丰富的数据视图，帮助个人和团队高效地规划与执行工作。本项目结合了传统的待办事项管理与现代化的项目协作功能，并集成了 AI 能力与第三方通知服务。

## 2. 功能模块分析

### 2.1 用户与安全 (User & Security)
**对应页面**: `登录界面`, `注册界面`, `个人中心`
**数据库支持**: `user`, `user_security`, `user_llm_config`, `user_dingtalk_robot`

*   **注册与登录**:
    *   支持用户名/邮箱/手机号注册。
    *   密码采用 Argon2 加密存储。
    *   支持 SSO 单点登录 (Google, Github, WeChat 等)。
*   **个人中心**:
    *   用户基本信息管理（头像、性别、备注）。
    *   安全设置：密码修改，AK/SK 管理（用于 API 访问）。
*   **高级配置**:
    *   **LLM 配置**: 管理 AI 模型参数（提供商、API Key、URL、模型名称、Temperature 等），支持 OpenAI, ModelScope, Ollama 等。
    *   **通知配置**: 管理钉钉机器人（Token, Secret, 关键字），实现消息推送集成。
*   **API调用**:
    *   用户 AccessKey/SecretKey 体系，便于开发者扩展或 API 调用。


### 2.2 项目/团队管理 (Team/Project Management)
**对应页面**: `新增项目`, `项目详情`
**数据库支持**: `team`, `team_user_relation`

*   **项目全生命周期管理**:
    *   **创建**: 用户创建新项目时，需设定项目名称、描述、头像，并可选择是否初始化默认任务族。
    *   **归档与删除**: 支持将不再活跃的项目归档（只读），或彻底删除（需二次确认，且仅 Owner 可操作）。
        *   *注*: 彻底删除将级联删除该项目团队下的所有任务族，以及与任务族相关联的任务、子任务、任务附件、任务节点、任务边和用户与有关实体的关系数据。
*   **成员管理与角色权限**:
    *   **邀请机制**:
        *   支持通过搜索用户名添加。
    *   **角色体系**:
        *   **Owner (创建者)**: 团队的最高管理者，每个团队仅限一人。
            *   *特权*: 解散团队、转让 Owner 身份、管理所有成员（包括 Manager）、配置团队全局设置（如可见性、默认视图）。
            *   *退出规则*: Owner 必须先将身份转让给其他成员后才能退出团队。
        *   **Manager (管理者)**: 协助运营团队的核心成员。
            *   *权限*: 邀请新成员、移除 Member 角色的成员、创建/编辑/删除任务族、管理团队内所有任务（分配、修改状态）、查看全量数据报表。
        *   **Member (普通成员)**: 具体的任务执行者。
            *   *权限*: 查看可见的任务族；创建任务；编辑/完成指派给自己的任务；上传附件；参与评论。
            *   *限制*: 无法修改团队设置，无法移除其他成员，无法查看私有任务族（除非被邀请）。
    *   **成员变动处理**:
        *   **移除成员**: 管理员移除成员时，系统应提示是否将其名下的未完成任务批量转移给其他成员，防止工作丢失。
        *   **状态流转**: `邀请中` -> `正常` (接受) / `已拒绝` -> `禁用` (保留历史数据但禁止访问) -> `移除` (彻底脱离关系)。
*   **项目配置与概览**:
    *   **概览面板**: 聚合展示项目进度、活跃成员动态、即将到期的任务分布。
    *   **偏好设置**: 支持设置项目的主题色、自定义任务优先级标签别名等。

### 2.3 任务族管理 (Task Groups)
**对应页面**: `任务族详情`, `新增私有任务族`
**数据库支持**: `task_group`, `task_group_user_relation`

*   **任务族概念**: 任务族是任务的集合容器，用于将任务按照特定的逻辑（如迭代、模块、类型）进行分类管理。
*   **任务族类型**:
    *   **项目任务族**: 隶属于特定的项目团队。
        *   **公开任务族**: 团队内所有成员可见。
        *   **私有任务族**: 仅创建者及被邀请的成员可见，用于敏感或小范围协作的任务。
    *   **个人私有任务族**: 不绑定任何项目团队，仅用户个人可见。
        *   用于存放个人的备忘录、临时待办或与工作无关的私人事项。
*   **默认任务族**:
    *   用户注册账号时，系统会自动创建一个默认的个人任务族（名称为“默认任务族”，类型为“个人私有任务族”）。
    *   **特性**: 该任务族不可被删除，且仅有用户自己可查看，确保用户始终有一个收集待办事项的入口。
*   **个性化与管理**:
    *   **自定义显示**: 支持为不同任务族设置专属颜色（Color Tag）和别名（Alias），便于在侧边栏快速识别，原有任务族名称在创建后不可修改。
    *   **排序**: 支持拖拽排序，用户可根据优先级调整任务族的展示顺序。

### 2.4 任务族内任务管理 (Task Management)
**对应页面**: `任务详情1`, `任务详情2`, `最近代办`
**数据库支持**: `task`, `task_user_relation`, `child_task`, `task_file`

*   **任务全流程管理**:
    *   **创建与编辑**: 支持快速创建任务，并可详细编辑任务描述，并设置截止时间、优先级、指派执行人、子任务等。
    *   **状态流转**: 
        *   `未开始` -> `进行中` -> `已完成`
        *   `已取消` (不再执行但需保留记录)
        *   `已禁用` (归档或异常终止)
    *   **优先级体系**: 提供 P0 (紧急/最高) 至 P4 (最低) 的 5 级优先级划分，支持通过颜色标签直观区分。
*   **任务拆解与子任务 (Child Tasks)**:
    *   **结构化拆解**: 支持将复杂任务（Parent Task）拆解为多个扁平化的子任务（Child Tasks），形成二级任务结构。
    *   **子任务特性**:
        *   **独立性**: 每个子任务拥有独立的 `状态`、`截止时间` 和 `指派执行人`，且`指派执行人`必须在该主任务的创建者或协助者列表中。
        *   **关联性**: 子任务的生命周期受父任务制约（如父任务彻底删除，子任务随之删除；父任务归档，子任务冻结）。
        *   **排序**: 支持通过拖拽调整子任务的执行顺序。
    *   **进度联动**: 父任务的完成度可配置为由子任务的完成比例自动计算（如 3/5 子任务完成 -> 父任务 60% 进度）。
*   **角色权限与协作**:
    *   **创建者 (Owner)**: 拥有任务的最高权限，可删除任务、修改核心属性（如截止时间、指派人）。
    *   **执行人 (Assignee)**: 
        *   **唯一性**: 每个任务（或子任务）同一时间只能有一名执行人。
        *   **权限**: 负责推进任务状态（流转至“已完成”）、更新进度、添加评论及附件。
    *   **协助者 (Followers)**: 
        *   **多人协作**: 支持添加多名成员关注此任务，但子任务仅允许单个协助者。
        *   **权限**: 接收任务变更通知，拥有查看权限和评论权限，可上传辅助资料，但无法修改任务核心属性（如截止时间）。 
*   **时间规划与记录**:
    *   **计划时间**: 设定 `开始时间` 和 `截止时间`，明确任务的时间跨度。
    *   **实际记录**: 系统自动记录 `完成时间`，用于后续的效能分析与逾期统计。
*   **资源挂载**:
    *   **附件管理**: 支持上传多种格式的文件（文档、图片、压缩包等），并记录上传者与上传时间，方便资料溯源。
*   **审计日志 (Audit Log)**:
    *   **操作记录**: 自动记录任务及其子任务的全生命周期操作，包括：
        *   **新增**: 任务/子任务创建时间、创建人。
        *   **修改**: 记录字段变更前后的值（如状态、截止时间、指派人变更）。
        *   **删除**: 记录删除操作及执行人。
    *   **聚合展示**: 子任务的审计日志会自动聚合至主任务的时间轴中，方便在主任务视角回溯完整的变更历史。



### 2.5 任务图谱 (Task Graph)
**数据库支持**: `task_node`, `task_edge`

*   **自动构建**:
    *   每当用户创建**任务**或**子任务**时，系统会自动在图谱中生成对应的**任务节点**。
    *   系统会自动构建任务与子任务之间的层级关系边（父子关系）。
*   **手动编排**:
    *   **依赖关系**: 用户可以在图谱中通过连线手动构建任务间的上下游依赖关系（如“任务 A 必须在任务 B 之前完成”）。
    *   **关系类型**: 系统提供多种边类型来表示不同的逻辑关系，包括但不限于：
        *   **串行 (Sequential)**: 强依赖，前置任务未完成时，后置任务不可开始。
        *   **并行 (Parallel)**: 弱依赖，表示逻辑上的关联但时间上可重叠。
        *   **关联 (Related)**: 仅表示参考关系。
    *   **可视化排版**: 支持用户在画布上自由拖拽节点位置，进行美化排版，系统记录节点的坐标信息。
*   **泛化节点扩展**:
    *   除了标准的任务节点外，系统还支持用户手动添加多种辅助节点：
        *   **笔记节点**: 记录富文本信息、会议纪要或灵感。
        *   **外链网页节点**: 嵌入外部 URL 链接。
        *   **外链文件节点**: 指向云存储或外部系统的文件地址。
        *   **数据节点**: 存储特定的 JSON 数据或键值对。
        *   **密码凭证节点**: 安全存储加密的敏感信息。
        *   **其他节点**
    *   **可见性控制**: 用户可设置这些辅助节点的可见范围（仅自己可见 / 团队可见），保护敏感信息。

### 2.6 视图与可视化 (Views & Visualization)
**对应页面**: `主页`, `侧边栏`, `日程概览`, `数据面板`, `数据模板-进行中任务甘特图`, `整体架构`

系统通过多维度的视图设计，满足用户在不同场景下的信息获取需求：

*   **全局导航 (Global Navigation)**:
    *   **侧边栏 (Sidebar)**: 采用折叠式设计，提供“主页”、“日程”、“项目列表”及“任务族”的快速切换入口。
    *   **快速操作**: 无论身处何处，均可通过全局“+”按钮快速创建任务或记录灵感。
*   **核心视图 (Core Views)**:
    *   **仪表盘 (Dashboard/Home)**:
        *   **今日聚焦**: 智能聚合“今日截止”、“已逾期”及“高优先级”任务，帮助用户保持专注。
        *   **动态通知**: 实时展示被指派、被@或协作任务的更新动态。
    *   **日程视图 (Calendar View)**:
        *   **多模式切换**: 支持月视图、周视图及日视图切换。
        *   **拖拽排期**: 支持直接在日历上拖拽任务色块来调整“开始时间”或“截止时间”。
    *   **甘特图 (Gantt Chart)**:
        *   **项目全景**: 以时间轴形式直观展示任务的起止时间、依赖关系及进度条。
        *   **关键路径**: 自动高亮影响项目交付的关键任务节点。
    *   **数据面板 (Analytics)**:
        *   **个人效能**: 统计个人的任务完成率、平均耗时及周活跃度趋势。
        *   **团队报表**: 展示团队的任务分布、成员负载情况及项目整体燃尽图 (Burndown Chart)。

### 2.7 集成与扩展 (Integrations)
**数据库支持**: `user_llm_config`, `user_dingtalk_robot`

*   **AI 能力集成**:
    *   支持配置 LLM (Large Language Model) 提供商 (OpenAI, ModelScope, Ollama)。
    *   支持配置 API Key, URL, 模型名称及参数 (Temperature, Thinking)。
    *   预期应用：AI 辅助任务拆解、周报生成、智能问答等。
*   **消息通知**:
    *   集成钉钉机器人 (DingTalk Robot)。
    *   支持配置 Token, Secret 及关键字，实现任务动态的实时群通知。