# Team 权限管控

依据《需求分析.md》《系统功能架构.md》以及后端 `TeamController` 已有接口，并结合基础 CRUD 操作，按“增、删、改、查”分类列出不同角色（owner / manager / member）的操作权限。

## 增（Create）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 创建团队 | `POST /api/teams` | 允许 | 允许 | 允许 | 任何已登录用户均可创建团队 |
| 邀请成员加入 | `POST /api/teams/{teamId}/members` | 允许 | 允许 | 禁止 | 仅可邀请为 `manager` 或 `member`；不可直接设为 `owner` |

## 删（Delete）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 删除团队 | `DELETE /api/teams/{teamId}` | 允许 | 禁止 | 禁止 | 仅团队所有者可删除团队 |
| 退出团队（当前用户） | `DELETE /api/teams/{teamId}/members/me` | 禁止 | 允许 | 允许 | 所有者不可退出团队；成员退出将清除相关任务族关系 |
| 删除团队成员（删除他人） | `DELETE /api/teams/{teamId}/members/{userId}` | 允许 | 允许 | 禁止 | 不可删除团队所有者 |
| 删除团队成员（删除自己） | `DELETE /api/teams/{teamId}/members/{userId}` | 禁止 | 允许 | 允许 | 所有者不可删除自身；其他成员可自行退出 |

## 改（Update）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 修改团队信息 | `PUT /api/teams/{teamId}` | 允许 | 禁止 | 禁止 | 仅团队所有者可以修改团队基本信息 |
| 接受邀请（当前用户） | `PUT /api/teams/{teamId}/invites/me/accept` | 允许 | 允许 | 允许 | 仅限处于“邀请中”的用户，接收后赋予邀请时指定的角色 |
| 拒绝邀请（当前用户） | `PUT /api/teams/{teamId}/invites/me/reject` | 允许 | 允许 | 允许 | 仅限处于“邀请中”的用户 |
| 修改成员角色 | `PUT /api/teams/{teamId}/members/{userId}/role` | 允许 | 允许 | 禁止 | 仅可设为 `manager` 或 `member`；禁止设为 `owner`；不可修改自身角色 |
| 交换个人两个团队的排序 | `PUT /api/teams/order` | 允许 | 允许 | 允许 | 需两个均为本人已加入的团队 |
| 修改个人团队颜色 | `PUT /api/teams/{teamId}/members/me/color` | 允许 | 允许 | 允许 | 颜色需满足 `#xxxxxx`（6位十六进制） |

## 查（Read）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 查询本人被邀请团队的记录 | `GET /api/teams/me/invites?memberStatus=2` | 允许 | 允许 | 允许 | 仅限本人；返回“邀请中”状态记录 |
| 查询本人拒绝的邀请团队记录 | `GET /api/teams/me/invites?memberStatus=3` | 允许 | 允许 | 允许 | 仅限本人；返回“已拒绝”状态记录 |
| 查询本人相关的团队（无需分页） | `GET /api/teams/me` | 允许 | 允许 | 允许 | 返回与本人有关的团队（已加入 + 邀请中 + 已拒绝），无需分页 |
| 查询团队基础信息 | `GET /api/teams/{teamId}` | 允许 | 允许 | 允许 | 仅团队成员可查看团队基础信息 |
| 查询团队数据大屏 | `GET /api/teams/{teamId}/dashboard` | 允许 | 允许 | 允许 | 仅团队成员可查看；内部内容 TODO |
| 团队成员分页 | `GET /api/teams/{teamId}/members` | 允许 | 允许 | 允许 | 仅团队成员可查看；支持用户名模糊、角色与邀请状态筛选 |
| 查看本人团队列表 | `GET /api/teams/me` | 允许 | 允许 | 允许 | 返回本人已加入团队及成员关系 |

术语说明：
- 角色：`owner`（所有者）、`manager`（管理员）、`member`（成员）
- 邀请状态（`memberStatus`）：`1` 已接受、`2` 邀请中、`3` 已拒绝





# TaskGroup 权限管控

依据《需求分析.md》《系统功能架构.md》以及后端 `TaskGroupController` 已有接口，并结合基础 CRUD 操作，按“增、删、改、查”分类列出不同角色（owner / manager / member）的操作权限。任务族既包含“个人私有任务族”（不绑定团队）也包含“团队任务族”（绑定团队）。以下接口当前覆盖“个人私有任务族”与“关系维度属性”的变更。

## 增（Create）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 创建私有任务族 | `POST /api/taskgroups` | 允许 | 允许 | 允许 | 仅本人使用的私有任务族；不需绑定项目团队；默认关系颜色 |

## 删（Delete）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 删除私有任务族 | `DELETE /api/taskgroups/{taskGroupId}` | 允许 | 允许 | 允许 | 仅创建者可删除；私有任务族（`teamId` 为空）；默认任务族不可删除；级联删除任务、子任务、附件、协助者关系等 |

## 改（Update）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 更新私有任务族 | `PUT /api/taskgroups/{taskGroupId}` | 允许 | 允许 | 允许 | 仅创建者可更新；限制为私有任务族（`teamId` 为空）；支持名称/描述/状态 |
| 交换我的两个任务族排序 | `PUT /api/taskgroups/order` | 允许 | 允许 | 允许 | 当前用户维度；需两个不同的任务族且均与本人存在关系 |
| 修改我的任务族颜色 | `PUT /api/taskgroups/{taskGroupId}/members/me/color` | 允许 | 允许 | 允许 | 关系维度，仅当前用户；颜色需为 `#xxxxxx`（6位十六进制） |
| 修改我的任务族别名 | `PUT /api/taskgroups/{taskGroupId}/members/me/alias` | 允许 | 允许 | 允许 | 关系维度，仅当前用户；别名非空且最长 64 字符 |

## 查（Read）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 列出本人相关任务族（无需分页） | `GET /api/taskgroups/me` | 允许 | 允许 | 允许 | 返回与本人存在关系的任务族（含私有与绑定团队的任务族）；按 `groupIndex` 升序，其次 `joinTime` 升序 |
| 查询任务族成员列表 | `GET /api/taskgroups/{taskGroupId}/members` | 允许 | 允许 | 允许 | 需为该任务族的正常成员；返回融合列表 `TaskGroupMemberResponse`，按用户名升序；仅返回正常成员 |

术语说明：
- 任务族：任务容器，支持私有与团队绑定两类；见 `task_group` 表
- 任务族成员关系：用户与任务族的关系与偏好设置；见 `task_group_user_relation` 表






# Task 权限管控
 
 依据《需求分析.md》《系统功能架构.md》以及 `task` 相关数据库设计（`task`、`task_user_relation`、`child_task`、`task_file`、`task_audit`），构建任务域接口与权限矩阵。任务域角色仅使用 `if_owner` 标识：`task_owner(if_owner=1)` 与 `task_member(if_owner=0)`。团队 RBAC 另见 Team 权限管控章节；本文任务域操作以 `if_owner` 区分。
 
## 增（Create）

| 操作 | 接口 | task_owner(if_owner=1) | task_member(if_owner=0) | 说明 |
|---|---|---|---|---|
| 创建任务 | `POST /api/tasks` | 允许 | 允许 | 需为目标任务族关系成员（私有任务族仅本人）；创建者自动成为 `task_owner(if_owner=1)`；请求体 `Task` 读取 `taskGroupId`、`teamId`、`taskName`、`taskDescription`、`taskStatus`、`taskPriority`、`startTime`、`dueTime` |
| 创建子任务 | `POST /api/tasks/{taskId}/children` | 允许 | 允许 | 请求体 `ChildTask` 读取 `childTaskName`、`dueTime`、`childTaskAssigneeId`、`childTaskIndex`；允许范围：任务的 `task_owner` 以及该子任务的指派执行人 |
| 上传任务附件 | `POST /api/tasks/{taskId}/files` | 允许 | 允许 | 请求体 `TaskFile` 读取 `taskFileName`、`taskFilePath`、`taskFileType`、`taskFileSize`；允许范围：任务的 `task_owner` 与任意 `task_member` |
| 添加协助者 | `POST /api/tasks/{taskId}/followers` | 允许 | 禁止 | 请求体读取协助者 `userId`；仅任务拥有者可添加协助者；重复邀请根据当前关系状态提示 |
 
 ## 删（Delete）
 
| 操作 | 接口 | task_owner(if_owner=1) | task_member(if_owner=0) | 说明 |
|---|---|---|---|---|
| 删除任务 | `DELETE /api/tasks/{taskId}` | 允许 | 禁止 | 仅 `task_owner` 可删除；级联删除子任务、附件、节点与边（图谱）、成员关系、审计日志 |
| 删除子任务 | `DELETE /api/tasks/{taskId}/children/{childTaskId}` | 允许 | 允许 | 子任务由任务的 `task_owner` 删除；执行人不可删除，仅可更新状态 |
| 删除协助者关系 | `DELETE /api/tasks/{taskId}/followers/{taskHelperId}` | 允许 | 允许（限本人） | 仅协助者本人或任务拥有者可删除；不可删除拥有者关系；被删除用户不得为子任务执行者 |
| 删除任务附件 | `DELETE /api/tasks/{taskId}/files/{taskFileId}` | 允许 | 允许（限本人上传） | 上传者可删除本人上传的附件；`task_owner` 可删除任意附件 |
 
 ## 改（Update）
 
| 操作 | 接口 | task_owner(if_owner=1) | task_member(if_owner=0) | 说明 |
|---|---|---|---|---|
| 更新任务基础信息 | `PUT /api/tasks` | 允许 | 允许 | 请求体`Task`可更新非核心字段（描述、优先级、计划时间、任务状态） |
| 更新子任务 | `PUT /api/tasks/{taskId}/children/{childTaskId}` | 允许 | 允许 | 请求体`ChildTask`仅更新非空字段；`childTaskName`≥2；`childTaskStatus`取值`0/1/2/3/4/5`（0禁用、1未开始、2进行中、3已完成、4已暂停、5已取消）；变更执行人需为协助者或已邀请用户，允许置空 |
| 调整子任务排序 | `PUT /api/tasks/{taskId}/children/order` | 允许 | 允许（所有执行者） | 请求体读取有序 `childTaskId` 列表；保持相同集且更新 `child_task_index` |
 
 ## 查（Read）
 
| 操作 | 接口 | task_owner(if_owner=1) | task_member(if_owner=0) | 说明 |
|---|---|---|---|---|
| 列出任务族任务 | `GET /api/tasks/taskgroups/{taskGroupId}/tasks` | 允许 | 允许 | 返回该任务族下任务列表；支持状态/优先级/时间范围/任务名称（模糊）/是否与我有关筛选 |
| 分页列出任务族任务 | `GET /api/tasks/taskgroups/{taskGroupId}/tasks/page` | 允许 | 允许 | 与上相同的筛选；返回分页数据结构 |
| 列出我的任务 | `GET /api/tasks/tasks/me` | 允许 | 允许 | 返回与当前用户有关的任务列表，支持状态/优先级/时间范围/任务名称（模糊）筛选 |
| 分页列出我的任务 | `GET /api/tasks/tasks/me/page` | 允许 | 允许 | 与上相同的筛选；返回分页数据结构 |
| 我的任务日程视图 | `GET /api/tasks/tasks/me/schedule?year=YYYY&month=MM` | 允许 | 允许 | 按年/月返回当月相关任务摘要；可选筛选 `taskGroupId` 列表 |
| 获取任务详情 | `GET /api/tasks/tasks/{taskId}` | 允许 | 允许 | 需为所属任务族关系成员 |
| 获取子任务列表 | `GET /api/tasks/tasks/{taskId}/children` | 允许 | 允许 | 需为任务族关系成员 |
| 获取任务附件列表 | `GET /api/tasks/tasks/{taskId}/files` | 允许 | 允许 | 需为任务族关系成员 |
| 获取审计日志 | `GET /api/tasks/tasks/{taskId}/audits` | 允许 | 允许 | 需为任务族关系成员；审计记录来源 `task_audit` |
 
 ## 设计说明与约束
 
 - 任务域角色：以 `task_user_relation.if_owner` 区分 `task_owner(1)` 与 `task_member(0)`；团队 RBAC 与可见性另见 Team 权限管控。  
 - 子任务执行人：使用 `child_task.child_task_assignee_id` 字段进行唯一指派；子任务支持独立状态机与排序。  
 - 状态枚举：`task.task_status` 采用枚举值（0禁用、1未开始、2进行中、3已完成、4已取消）；禁止越权流转。  
 - 图谱联动：任务创建/删除自动同步到 `task_node` 与 `task_edge`，以保持图谱一致性。  
 - 审计记录：对任务与子任务的新增、更新、删除操作写入 `task_audit`，用于变更追踪与合规审计。  
 
 术语说明：
 - 任务：见 `task` 表；核心属性包含状态、优先级与时间维度
 - 协助者关系：见 `task_user_relation` 表；维护创建者与协助者集合
 - 子任务：见 `child_task` 表；独立状态与执行人
 - 附件：见 `task_file` 表；记录上传者与文件元数据
- 审计：见 `task_audit` 表；记录变更操作与时间轴

# 统计总结接口

## 用户统计（User）

| 操作 | 接口 | task_owner(if_owner=1) | task_member(if_owner=0) | 说明 |
|---|---|---|---|---|
| 概览（加入统计） | `GET /api/stats/me/overview/joined` | 允许 | 允许 | 仅本人；加入的团队数与任务族数（单图表/卡片） |
| 概览（进行中） | `GET /api/stats/me/overview/in_progress` | 允许 | 允许 | 仅本人；进行中任务与子任务数量（单图表/卡片） |
| 概览（已完成-周） | `GET /api/stats/me/overview/completed/week` | 允许 | 允许 | 仅本人；本周完成数量（单图表/卡片） |
| 概览（已完成-月） | `GET /api/stats/me/overview/completed/month` | 允许 | 允许 | 仅本人；本月完成数量（单图表/卡片） |
| 概览（已完成-总计） | `GET /api/stats/me/overview/completed/total` | 允许 | 允许 | 仅本人；累计完成数量（单图表/卡片） |
| 概览（逾期摘要） | `GET /api/stats/me/overview/overdue` | 允许 | 允许 | 仅本人；逾期总计/中度/严重分层计数（单图表/卡片） |
| 负载趋势（近N天） | `GET /api/stats/me/trend/load?days=14` | 允许 | 允许 | 仅本人；最近N天任务/子任务每日数量趋势（折线图，双序列） |
| 创建/完成趋势 | `GET /api/stats/me/trend/tasks?range=week\|month&from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 仅本人；创建数与完成数趋势（折线图） |
| 完成率趋势 | `GET /api/stats/me/trend/completion?range=week\|month&from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 仅本人；按时间聚合的完成率曲线（折线/面积图） |
| 活跃度趋势（审计） | `GET /api/stats/me/trend/activity?range=week\|month&from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 仅本人；基于 `task_audit` 的操作事件计数（柱/折线图） |
| 优先级分布 | `GET /api/stats/me/distribution/priority?scope=tasks\|subs` | 允许 | 允许 | 仅本人；按 `task_priority` 的占比（环形图，任务/子任务可选） |
| 状态分布 | `GET /api/stats/me/distribution/status?scope=tasks\|subs` | 允许 | 允许 | 仅本人；按 `task_status` 的占比（环形图，任务/子任务可选） |
| DDL到期分析 | `GET /api/stats/me/expiration/forecast?buckets=7d,3d,today&scope=tasks\|subs` | 允许 | 允许 | 仅本人；到期窗口分布（柱状图，任务/子任务双序列） |
| 逾期统计 | `GET /api/stats/me/overdue?from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 仅本人；逾期数量与摘要（单图表） |
| 平均响应时间（MTTR） | `GET /api/stats/me/mttr?from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 仅本人；从开始到完成的平均耗时（单值或趋势） |

## 团队统计（Team）

| 操作 | 接口 | owner | manager | member | 说明 |
|---|---|---|---|---|---|
| 团队概览统计 | `GET /api/stats/teams/{teamId}/overview` | 允许 | 允许 | 允许 | 需为团队正常成员；状态/优先级/逾期等摘要 |
| 任务分布（状态/优先级） | `GET /api/stats/teams/{teamId}/distribution?by=status\|priority` | 允许 | 允许 | 允许 | 饼/柱图数据源 |
| 成员负载统计 | `GET /api/stats/teams/{teamId}/workload?scope=in_progress\|all` | 允许 | 允许 | 允许 | 每成员进行中/全部任务数量与趋势 |
| 团队燃尽图 | `GET /api/stats/teams/{teamId}/burndown?from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 允许 | 迭代/时间窗口燃尽数据 |
| 团队逾期统计 | `GET /api/stats/teams/{teamId}/overdue?from=YYYY-MM-DD&to=YYYY-MM-DD` | 允许 | 允许 | 允许 | 逾期数量与按成员/任务族分布 |
| 活跃度趋势（审计） | `GET /api/stats/teams/{teamId}/trend/activity?range=week\|month` | 允许 | 允许 | 允许 | 基于 `task_audit` 的团队操作事件计数 |
| 图谱摘要 | `GET /api/stats/teams/{teamId}/graph/summary` | 允许 | 允许 | 允许 | 任务节点/边数量与类型分布 |

## 设计说明

- 所有统计接口默认以“单图表单位”返回可视化友好数据结构（`labels`、`series`、`legend`、`total` 等），便于前端自由组合。
- 过滤参数通用约定：`from/to`（日期范围）、`range=week|month`（聚合粒度）、`by=status|priority`（维度选择）。
- 权限规则遵循各域 RBAC：
  - 用户统计：仅本人；
  - 团队统计：需为团队正常成员；
  - 任务统计：需为该任务所属任务族的正常成员（并按 `task_owner / task_member` 区分）。
